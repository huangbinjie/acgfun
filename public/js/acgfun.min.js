var app=angular.module("acgfun",["ngRoute","ngResource","ngCookies","angularFileUpload"]);app.config(["$routeProvider","$locationProvider","$httpProvider","$resourceProvider",function($routeProvider,$locationProvider,$httpProvider,$resourceProvider){$locationProvider.html5Mode(!0),$httpProvider.defaults.useXDomain=!0,delete $httpProvider.defaults.headers.common["X-Requested-With"],$resourceProvider.defaults.stripTrailingSlashes=!1,$routeProvider.when("/",{templateUrl:"main.html",controller:"mainCtrl"}).when("/login",{templateUrl:"login.html",controller:"loginCtrl"}).when("/[acgm]",{templateUrl:"page.html",controller:"pageCtrl"}).when("/[acgm]/:pid/:title",{templateUrl:"topic.html",controller:"topicCtrl"}).when("/user",{templateUrl:"user.html",controller:"userCtrl"}).when("/user/active",{templateUrl:"active.html",controller:"activeCtrl"}).when("/user/reActive",{templateUrl:"reActive.html",controller:"reActiveCtrl"}).when("/user/:uid",{templateUrl:"user.html",controller:"userCtrl"}).when("/plaza",{templateUrl:"plaza.html",controller:"plazaCtrl"}).otherwise({templateUrl:"404.html"})}]).run(function($rootScope,Auth,$loadingBar,$anchorScroll,$location,$routeParams,$timeout){$rootScope.signOut=Auth.signOut,$rootScope.$on("$viewContentLoaded",function(){$loadingBar("100%",!0)}),$rootScope.$on("$routeChangeSuccess",function(){$routeParams.scrollTo&&($location.hash($routeParams.scrollTo),$timeout(function(){$anchorScroll()},1e3))})});
app.controller("loginCtrl",["$scope","$http","$message","$loadingBar","$rootScope","$location","Auth",function($scope,$http,$message,$loadingBar,$rootScope,$location,Auth){function success(){$("#register").slideUp(400,function(){$("#login").slideDown()})}$rootScope.showEditor=!1,$rootScope.showOpenEditor=!1,$rootScope.showCrumb=!1,$scope.login=function(){return void 0===$scope.login_email||""===$scope.login_email?void $message("请填写邮箱",90):void 0===$scope.login_password||""===$scope.login_password?void $message("请填写密码",90):($loadingBar("80%"),void $http.post("/login",{email:$scope.login_email,password:$scope.login_password}).success(function(data){"success"===data.result?(Auth.setUser(JSON.stringify(data.user)),$loadingBar("100%","/")):$message(void 0!==data.msg?data.msg:"登陆失败",90)}))},$scope.regist=function(){return void 0===$scope.register_email||""===$scope.register_email?void $message("请填写邮箱",90):void 0===$scope.register_password||""===$scope.register_password?void $message("请填写密码",90):void 0===$scope.register_nick||""===$scope.register_nick?void $message("请填写昵称",90):($loadingBar("80%"),void $http.post("/register",{nick:$scope.register_nick,email:$scope.register_email,password:$scope.register_password}).success(function(data){"success"===data.result?($message("注册成功,请前往邮箱激活账号<br/><a href='/user/reActive'>没有收到？</a>",90,0),$loadingBar("100%",success)):($message(void 0!==data.msg?data.msg:"注册失败",90),$loadingBar("80%"))}))},aaa=function(){alert("111")}}]),app.controller("mainCtrl",["$scope","$rootScope","$message","Auth","$loadingBar",function($scope,$rootScope,$message,Auth){$rootScope.showEditor=!1,$rootScope.showOpenEditor=!1,$rootScope.showCrumb=!1,Auth.getUser()}]),app.controller("pageCtrl",["$scope","$rootScope","$message","$location","Post","Auth","$loadingBar","$crumb",function($scope,$rootScope,$message,$location,Post,Auth,$loadingBar,$crumb){function dis(){return 1===$scope.pageCounts.length?($scope.left=!1,void($scope.right=!1)):($scope.left=0===$scope.currentPage?!1:!0,void($scope.right=$scope.currentPage>=$scope.pageCounts.length?!1:!0))}$rootScope.showEditor=!1,$rootScope.editType="post",$rootScope.showOpenEditor=!0,$rootScope.showCrumb=!0,Auth.getUser(),$crumb($location.path()),$scope.url=$location.path(),$scope.currentPage=0,$scope.$on("postSuccess",function(){$scope.query(0)}),$scope.query=function(){Post($location.path()).list(function(data){$scope.topics=data.posts,$scope.pageCounts=[];for(var i=0;i<Math.ceil(data.count/30);i++)$scope.pageCounts.push(i);$scope.pagination=!0,dis($scope.currentPage),window.scrollTo(0,0),$loadingBar("100%")})},$scope.query(0)}]),app.controller("topicCtrl",["$scope","$rootScope","$location","Topic","Auth","$loadingBar","$crumb","$message","Follow","Star",function($scope,$rootScope,$location,Topic,Auth,$loadingBar,$crumb,$message,Follow,Star){function dis(){return 1===$scope.pageCounts.length?($scope.left=!1,void($scope.right=!1)):($scope.left=0===$scope.currentPage?!1:!0,void($scope.right=$scope.currentPage>=$scope.pageCounts.length-1?!1:!0))}$rootScope.editType="reply",$rootScope.showOpenEditor=!0,$rootScope.showCrumb=!0,$rootScope.showEditor=!1,Auth.getUser(),$scope.User=$rootScope.User,$crumb($location.path()),$scope.currentPage=0,$scope.query=function(skip){$scope.currentPage=skip,Topic($location.path()).get({skip:30*skip},function(data){$scope.topic=data,$scope.pageCounts=[];for(var i=0;i<Math.ceil($scope.topic.count/30);i++)$scope.pageCounts.push(i);$scope.pagination=!0,dis($scope.currentPage),window.scrollTo(0,0),$loadingBar("100%")})},$scope.query(0),$scope.$on("postSuccess",function(){$scope.query(0)}),$scope.star=function(pid){Star.add({pid:pid},function(data){"success"===data.result?($message("收藏成功"),$("body").click()):$message(data.msg?data.msg:"收藏失败")})},$scope.follow=function(uid){Follow.add({uid:uid},function(data){"success"===data.result?($message("关注成功"),$("body").click()):$message(data.msg?data.msg:"关注失败")})},$scope.delete=function(id,itemType){Topic($location.path()).delete({id:id,type:itemType},function(data){"success"===data.result?($message("已删除"),"p"===itemType&&$location.path($location.path().substring(0,$location.path().lastIndexOf("/"))),"c"===itemType&&$("#"+id).remove()):$message("删除失败")})}}]),app.controller("userCtrl",["$scope","$location","User","$loadingBar","$rootScope","Auth","$upload","$message","$crumb","$routeParams",function($scope,$location,User,$loadingBar,$rootScope,Auth,$upload,$message,$crumb,$routeParams){$rootScope.showCrumb=!0,$rootScope.showOpenEditor=!1,$scope.showModal=!1,Auth.getUser(),$crumb($location.path()),$scope.showChangeFace=$routeParams.uid?!1:!0,User($location.path()).get({},function(data){$scope.userData=data,console.log(data)}),$scope.onFileSelect=function($files){$scope.file=$files[0]},$scope.submit=function(){return void 0===$scope.file?void $message("请选择文件"):void $upload.upload({url:"/upload/face",method:"POST",file:$scope.file}).progress(function(evt){$(".progressbar").show().width(parseInt(100*evt.loaded/evt.total)+"%")}).success(function(data){console.log(data),"success"===data.result?($message("上传头像成功"),$rootScope.showModal=!1,$scope.userData.user.face=data.face,$rootScope.User.face=data.face,window.sessionStorage.User=JSON.stringify($rootScope.User)):$message("上传头像失败了")})}}]),app.controller("activeCtrl",["$scope","$http","$location",function($scope,$http,$location){$http.post("/user/active",$location.search()).success(function(data){$scope.active=data.msg})}]),app.controller("reActiveCtrl",["$scope","$http","$message",function($scope,$http,$message){$scope.send=function(){return void 0===$scope.email||""===$scope.email?void $message("请填写邮箱",90):void $http.post("/user/reActive",{email:$scope.email}).success(function(data){$message("success"===data.result?"发送成功，请前往邮箱查收":"发送失败")})}}]),app.controller("plazaCtrl",["$scope",function(){}]);
app.directive("login",function(){return{link:function(){$("#change").click(function(){$("#login").slideUp(400,function(){$("#register").slideDown()})}),$("#cancel").click(function(){$("#register").slideUp(400,function(){$("#login").slideDown()})})}}}),app.directive("nav",function($rootScope,$routeParams){return{link:function(){$("#menu-btn").click(function(){$("#menu").width("100px"),$(this).hide()}),$("#menu #close").click(function(){$("#menu").width("0px"),$("#menu-btn").show()}),$("#menu #open").click(function(){$rootScope.showEditor=!0,"reply"===$rootScope.editType?$(".editor_title").val("回复:"+$routeParams.title).attr("disabled","true"):"post"===$rootScope.editType&&$(".editor_title").val("").removeAttr("disabled")})}}}),app.directive("a",function($loadingBar){return{restrict:"E",link:function($scope,element){element.on("click",function(){$loadingBar("80%")})}}}),app.directive("ngView",function(){return{restrict:"C",link:function($scope,element){element.on("click",function(){$("#menu").width("0px"),$("#menu-btn").show()})}}}),app.directive("editor",["Post","Topic","$rootScope","$message","$routeParams",function(Post,Topic,$rootScope,$message,$routeParams){return{restrict:"C",link:function(){$(".editor .close").click(function(){$rootScope.$apply(function(){$rootScope.showEditor=!1})})},controller:function($scope,$location){$scope.submit=function(){var title=$(".editor_title").val(),content=$(".editor iframe").contents().find("body").html();return void 0===title||""===title||null===title?void $message("标题不能为空"):void 0===content||""===content||null===content?void $message("请填写内容.."):("post"===$rootScope.editType&&Post($location.path()).add({title:title,content:content},function(data){"success"===data.result?($message("发帖成功"),$(".editor_title").val(""),$(".editor iframe").contents().find("body").html(""),$rootScope.showEditor=!1,$rootScope.$broadcast("postSuccess")):$message("发帖失败")}),void("reply"===$rootScope.editType&&Topic($location.path()).add({content:content,post_id:$routeParams.pid,post_user_id:$("#post_user_id").val()},function(data){"success"===data.result?($message("发帖成功"),$(".editor iframe").contents().find("body").html(""),$rootScope.showEditor=!1,$rootScope.$broadcast("postSuccess")):$message("发帖失败")})))}}}}]),app.directive("compile",function($compile){return{restrict:"A",link:function($scope,element,attr){$scope.$watch(attr.compile,function(text){element.html(text),$compile(element.contents())($scope)})}}}),app.directive("dropdown",function(){return{link:function($scope,element){element.on("click",function(e){e.stopPropagation(),$(this).find(".dropdown-menu").slideDown()}),$(window).click(function(){$(".dropdown-menu").slideUp()})}}}),app.directive("toTop",function($window){return{restrict:"C",link:function($scope,element){var window=angular.element($window);window.on("scroll",function(){window.scrollTop()>window.height()?element.css("opacity","1"):element.css("opacity","0")}),element.on("click",function(){$window.scrollTo(0,0)})}}}),app.directive("plaza-panel",function(){return{restrict:"C",link:function(){}}}),app.directive("plazaPanelBtn",function(){return{restrict:"C",link:function($scope,element){element.on("click",function(){angular.element(this).hasClass("light-orange")?(angular.element(this).removeClass("light-orange"),angular.element(this).css("background","#52c569"),$(".plaza-panel").slideUp()):(angular.element(this).addClass("light-orange"),angular.element(this).css("background","lightcoral"),$(".plaza-panel").slideDown())})}}}),app.directive("chatBtn",function(){return{restrict:"C",link:function($scope,element){element.on("click",function(){$(".chat-panel").toggle(500)})}}}),app.directive("chat",function(){return{restrict:"A",link:function(){io.connect("http://localhost")}}});
app.filter("dateCustom",function(){return function(input){var date=Date.now()-new Date(input).getTime();return 6e4>date?Math.round(date/1e3)+"秒前":36e5>date?Math.round(date/6e4)+"分钟前":864e5>date?Math.round(date/36e5)+"小时前":6048e5>date?+Math.round(date/864e5)+"天前":2592e6>date?Math.round(date/6048e5)+"星期前":31536e6>date?Math.round(date/2592e6)+"个月前":Math.round(date/31536e6)+"年前"}});
app.factory("User",["$resource",function($resource){return $resource("/user",{},{query:{method:"GET"}})}]),app.factory("$message",function($timeout){var $message=function(message,top,time){var width=($("body").width()-$("#message").width())/2;$("#message").empty().append(message).css({opacity:".8",left:width,top:void 0!==top?top:100}),0!==time&&$timeout(function(){$("#message").css({opacity:"0",left:width,top:-100})},3e3)};return $message}),app.factory("$loadingBar",function($timeout,$location){var load=function(width,fuc){return"boolean"==typeof fuc&&fuc===!0||($(".loading-bar").remove(),$("#background-img").after("<div class='loading-bar'></div>")),$(".loading-bar").width(width),"100%"===width&&$timeout(function(){$(".loading-bar").remove()},1e3),fuc instanceof Function?void fuc():void("string"==typeof fuc&&$location.path(fuc))};return load}),app.factory("Post",function($resource){return function(path){return $resource(path,{},{list:{method:"POST",isArray:!1},add:{method:"PUT"},"delete":{method:"DELETE"}})}}),app.factory("Topic",function($resource){return function(path){return $resource(path,{},{get:{method:"POST",isArray:!1},add:{method:"PUT"},"delete":{method:"DELETE"}})}}),app.factory("User",function($resource){return function(path){return $resource(path,{},{get:{method:"POST",isArray:!1},add:{method:"PUT"},"delete":{method:"DELETE"}})}}),app.factory("Auth",function($cookies,$rootScope,$http,$message){var auth={getUser:function(){void 0!==window.sessionStorage.User&&($rootScope.User=JSON.parse(window.sessionStorage.User))},signOut:function(){$http.post("/signout").success(function(data){"success"===data.result?($message("成功推出"),window.sessionStorage.removeItem("User"),$rootScope.User=window.sessionStorage.User):$message("退出失败")})},setUser:function(user){window.sessionStorage.User=user}};return auth}),app.factory("$crumb",function($location,$rootScope){return function(path){$rootScope.crumbs=[],/^\/*/.test(path)&&$rootScope.crumbs.push("<a href='/'>主页</a>"),/^\/a.*/.test(path)&&($rootScope.crumbs.push("/"),$rootScope.crumbs.push("<a href='/a'>动画</a>")),/^\/c.*/.test(path)&&($rootScope.crumbs.push("/"),$rootScope.crumbs.push("<a href='.c'>漫画</a>")),/^\/g.*/.test(path)&&($rootScope.crumbs.push("/"),$rootScope.crumbs.push("<a href='/g'>游戏</a>")),/^\/m.*/.test(path)&&($rootScope.crumbs.push("/"),$rootScope.crumbs.push("<a href='/m'>音乐</a>")),/^\/[acgm]\/+.*/.test(path)&&($rootScope.crumbs.push("/"),$rootScope.crumbs.push(path.split("/").slice(-1)[0])),/^\/(user).*/.test(path)&&($rootScope.crumbs.push("/"),$rootScope.crumbs.push("个人中心"))}}),app.factory("Star",function($resource){return $resource("/user/star",{},{get:{method:"POST",isArray:!1},add:{method:"PUT"},"delete":{method:"DELETE"}})}),app.factory("Follow",function($resource){return $resource("/user/follow",{},{get:{method:"POST",isArray:!1},add:{method:"PUT"},"delete":{method:"DELETE"}})});